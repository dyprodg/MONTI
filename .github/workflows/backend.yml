name: Backend

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - Backend/**
      - monitoring/**
      - Caddyfile
      - docker-compose.prod.yml
      - .github/workflows/backend.yml
  pull_request:
    branches: [main]
    paths:
      - Backend/**
      - monitoring/**
      - Caddyfile
      - docker-compose.prod.yml
      - .github/workflows/backend.yml

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache-dependency-path: Backend/go.sum

      - name: Vet
        run: go vet ./...

      - name: Test
        run: go test -v -race -coverprofile=coverage.out ./...

  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs: test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push
        working-directory: Backend
        run: |
          docker build -t ${{ vars.ECR_REGISTRY }}/monti-backend:latest \
                        -t ${{ vars.ECR_REGISTRY }}/monti-backend:${{ github.sha }} .
          docker push ${{ vars.ECR_REGISTRY }}/monti-backend:latest
          docker push ${{ vars.ECR_REGISTRY }}/monti-backend:${{ github.sha }}

      - name: Prepare EC2 directories
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/ec2-user/monti/monitoring/prometheus
            mkdir -p /home/ec2-user/monti/monitoring/grafana/provisioning/datasources
            mkdir -p /home/ec2-user/monti/monitoring/grafana/provisioning/dashboards
            mkdir -p /home/ec2-user/monti/monitoring/grafana/dashboards

      - name: Copy config files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "monitoring/,Caddyfile,docker-compose.prod.yml"
          target: /home/ec2-user/monti

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          command_timeout: 5m
          script: |
            cd /home/ec2-user/monti
            aws ecr get-login-password --region ${{ vars.AWS_REGION }} | docker login --username AWS --password-stdin ${{ vars.ECR_REGISTRY }}
            cp docker-compose.prod.yml docker-compose.yml
            docker compose pull backend
            docker compose down --timeout 10
            docker compose up -d
            docker image prune -f
            sleep 30
            echo "=== Container Status ==="
            docker compose ps
            echo "=== Health Check ==="
            curl -sf http://localhost:8080/health && echo "" || echo "WARNING: Backend health check failed"
            echo "=== Backend Logs (last 30 lines) ==="
            docker compose logs --tail 30 backend
